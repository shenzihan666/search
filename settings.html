<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #1a1a1a;
      color: white;
      padding: 24px;
      min-height: 100vh;
    }

    .container {
      max-width: 450px;
      margin: 0 auto;
    }

    h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 24px;
    }

    .field {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
    }

    input, select {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      color: white;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }

    input:focus, select:focus {
      border-color: rgba(99, 102, 241, 0.5);
    }

    .hint {
      display: block;
      margin-top: 8px;
      font-size: 12px;
      color: rgba(99, 102, 241, 0.8);
      text-decoration: none;
    }

    .hint:hover {
      color: #6366f1;
    }

    .error {
      color: #ef4444;
      font-size: 14px;
      margin-bottom: 16px;
      padding: 12px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 8px;
    }

    .success {
      color: #22c55e;
      font-size: 14px;
      margin-bottom: 16px;
      padding: 12px;
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 8px;
    }

    .actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    button.primary {
      background: #6366f1;
      color: white;
    }

    button.primary:hover:not(:disabled) {
      background: #4f46e5;
    }

    button.secondary {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    button.secondary:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Settings</h1>

    <div class="field">
      <label for="provider">Provider</label>
      <select id="provider">
        <option value="openai">OpenAI</option>
        <option value="gemini">Google Gemini</option>
        <option value="zhipu">智谱 AI (BigModel)</option>
      </select>
    </div>

    <div class="field">
      <label id="api-key-label" for="api-key">OpenAI API Key</label>
      <input
        id="api-key"
        type="password"
        placeholder="sk-..."
      />
      <a id="hint-link" href="#" target="_blank" class="hint" style="display: none;">Get your Gemini API key</a>
    </div>

    <div class="field">
      <label for="model">Model</label>
      <select id="model">
        <option value="gpt-4o-mini">GPT-4o Mini (Fast, Cheap)</option>
        <option value="gpt-4o">GPT-4o (Best)</option>
        <option value="gpt-4-turbo">GPT-4 Turbo</option>
        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
      </select>
    </div>

    <div id="status"></div>

    <div class="actions">
      <button class="secondary" id="close-btn">Close</button>
      <button class="primary" id="save-btn">Save</button>
    </div>
  </div>

  <script type="module">
    import { invoke } from '@tauri-apps/api/core';
    import { getCurrentWindow } from '@tauri-apps/api/window';
    import Database from '@tauri-apps/plugin-sql';

    const DB_URL = 'sqlite:config.db';
    let db = null;

    const openaiModels = [
      { value: 'gpt-4o-mini', label: 'GPT-4o Mini (Fast, Cheap)' },
      { value: 'gpt-4o', label: 'GPT-4o (Best)' },
      { value: 'gpt-4-turbo', label: 'GPT-4 Turbo' },
      { value: 'gpt-3.5-turbo', label: 'GPT-3.5 Turbo' },
    ];

    const geminiModels = [
      { value: 'gemini-2.0-flash', label: 'Gemini 2.0 Flash (Fast)' },
      { value: 'gemini-1.5-flash', label: 'Gemini 1.5 Flash' },
      { value: 'gemini-1.5-pro', label: 'Gemini 1.5 Pro' },
    ];

    const zhipuModels = [
      { value: 'glm-4-flash', label: 'GLM-4-Flash (快速)' },
      { value: 'glm-4-plus', label: 'GLM-4-Plus (增强)' },
      { value: 'glm-4', label: 'GLM-4 (标准)' },
      { value: 'glm-4-air', label: 'GLM-4-Air (轻量)' },
      { value: 'glm-4-airx', label: 'GLM-4-AirX (极速)' },
      { value: 'glm-4-long', label: 'GLM-4-Long (长文本)' },
      { value: 'glm-4v-plus', label: 'GLM-4V-Plus (多模态)' },
    ];

    const providerSelect = document.getElementById('provider');
    const apiKeyInput = document.getElementById('api-key');
    const apiKeyLabel = document.getElementById('api-key-label');
    const modelSelect = document.getElementById('model');
    const hintLink = document.getElementById('hint-link');
    const statusDiv = document.getElementById('status');
    const saveBtn = document.getElementById('save-btn');
    const closeBtn = document.getElementById('close-btn');

    let isSaving = false;

    // Initialize database and config table
    async function initDatabase() {
      try {
        db = await Database.load(DB_URL);
        await db.execute(`
          CREATE TABLE IF NOT EXISTS config (
            id INTEGER PRIMARY KEY,
            data TEXT NOT NULL
          )
        `);
      } catch (e) {
        console.error('Failed to initialize database:', e);
      }
    }

    // Load config from database
    async function loadConfigFromDb() {
      try {
        const result = await db.select('SELECT data FROM config WHERE id = 1');
        if (result && result.length > 0) {
          return JSON.parse(result[0].data);
        }
      } catch (e) {
        console.error('Failed to load config from database:', e);
      }
      return null;
    }

    // Persist config to database
    async function saveConfigToDb(config) {
      if (!db) {
        await initDatabase();
      }
      const configJson = JSON.stringify(config);
      await db.execute(
        'INSERT OR REPLACE INTO config (id, data) VALUES (1, $1)',
        [configJson]
      );
    }

    // Load config on start
    async function loadConfig() {
      try {
        await initDatabase();
        let config = await loadConfigFromDb();

        // Fallback to backend in-memory config
        if (!config) {
          config = await invoke('get_config');
        }

        apiKeyInput.value = config.api_key || '';
        providerSelect.value = config.provider_type || 'openai';
        updateModelOptions(config.provider_type || 'openai');

        // Set default model based on provider
        let defaultModel = 'gpt-4o-mini';
        if (config.provider_type === 'gemini') {
          defaultModel = 'gemini-2.0-flash';
        } else if (config.provider_type === 'zhipu') {
          defaultModel = 'glm-4-flash';
        }
        modelSelect.value = config.model || defaultModel;
      } catch (e) {
        console.error('Failed to load config:', e);
      }
    }

    function updateModelOptions(provider) {
      modelSelect.innerHTML = '';
      let models;
      switch (provider) {
        case 'gemini':
          models = geminiModels;
          break;
        case 'zhipu':
          models = zhipuModels;
          break;
        default:
          models = openaiModels;
      }
      models.forEach(m => {
        const option = document.createElement('option');
        option.value = m.value;
        option.textContent = m.label;
        modelSelect.appendChild(option);
      });
    }

    function updateUI() {
      const provider = providerSelect.value;
      if (provider === 'gemini') {
        apiKeyLabel.textContent = 'Gemini API Key';
        apiKeyInput.placeholder = 'AIza...';
        hintLink.href = 'https://aistudio.google.com/app/apikey';
        hintLink.style.display = 'block';
        hintLink.textContent = 'Get your Gemini API key';
      } else if (provider === 'zhipu') {
        apiKeyLabel.textContent = '智谱 API Key';
        apiKeyInput.placeholder = 'xxx.xxxxxxxx...';
        hintLink.href = 'https://open.bigmodel.cn/api-keys';
        hintLink.style.display = 'block';
        hintLink.textContent = '获取智谱 API Key';
      } else {
        apiKeyLabel.textContent = 'OpenAI API Key';
        apiKeyInput.placeholder = 'sk-...';
        hintLink.style.display = 'none';
      }
    }

    providerSelect.addEventListener('change', () => {
      updateUI();
      updateModelOptions(providerSelect.value);
      // Reset model to first option
      modelSelect.selectedIndex = 0;
    });

    async function saveConfig() {
      if (isSaving) return;
      if (!apiKeyInput.value.trim()) {
        showStatus('API key is required', 'error');
        return;
      }

      isSaving = true;
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      try {
        const config = {
          api_key: apiKeyInput.value.trim(),
          model: modelSelect.value,
          provider_type: providerSelect.value
        };

        // Save in-memory for current process
        await invoke('set_config', { config });
        // Persist across restarts
        await saveConfigToDb(config);

        showStatus('Settings saved successfully!', 'success');
        setTimeout(() => {
          getCurrentWindow().close();
        }, 1000);
      } catch (e) {
        showStatus(typeof e === 'string' ? e : 'Failed to save', 'error');
      } finally {
        isSaving = false;
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save';
      }
    }

    function showStatus(message, type) {
      statusDiv.textContent = message;
      statusDiv.className = type;
    }

    saveBtn.addEventListener('click', saveConfig);
    closeBtn.addEventListener('click', () => getCurrentWindow().close());

    // Handle Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        getCurrentWindow().close();
      }
    });

    // Initial load
    loadConfig();
    updateUI();
  </script>
</body>
</html>
